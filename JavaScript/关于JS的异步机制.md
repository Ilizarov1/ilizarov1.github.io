# JS 的异步

## 1. 基本介绍

- JS 是单线程语言，异步任务需要等待线程执行完所以同步任务后才能执行

- JS 引擎执行时，每当遇到异步任务就将其加入任务队列，等待合适时机执行

- 当线程中的任务执行完成后，事件循环会依次执行任务队列中的任务

## 2. 事件循环

[深入：微任务与Javascript运行时环境 - Web API 接口参考 | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%EF%BC%88event_loops%EF%BC%89)

- 在执行 JS 代码时，运行时实际上维护着一组用于执行 JS 代码的代理，每个代理由执行上下文、执行上下文栈、主线程、一组可能创建 worker 的额外线程集合、一个任务队列和一个微任务队列。

- 每个代理均由事件循环驱动，事件循环负责收集用户事件、对事件排队并在合适时机调用回调函数，然后执行所有在等待中的任务，再是微任务，最后在下一次循环之前执行必要的渲染和绘制。

- 三种事件循环：
  
  - window 事件循环
  
  - worker 事件循环
  
  - worklet 事件循环

- 特定情况下共享事件循环：
  
  - 一个窗口打开了另一个窗口，可能共享
  
  - iframe 会和包含它的窗口共享
  
  - 多进程浏览器中多个窗口碰巧共享同一进程

## 3. 任务和微任务

- 每次事件循环开始时，先执行任务队列，再执行微任务队列

- 任务队列在执行完毕后，必须等待下一次事件循环才能执行

- 在本次循环中增加到微任务队列的微任务，会在本次循环中执行完

# 异步方案
